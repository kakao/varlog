- Authors: pharraell.jang, jun.song
- Reviewers: jun.song, pharraell.jang
- Date: 
- Link: https://wiki.daumkakao.com/x/_eSQJw

# Management
Varlog 클러스터 관리, Storage Node 및 Metadata Repository 제어에 대한 설명을 한다.

## Storage Node 시작

SN (Storage Node) 프로세스는 시작할 때 여러 옵션들이 필요하다.

- CID (ClusterID)
  - SN이 속한 Varlog cluster 식별자
  - e.g., CID가 다른 SN이 클러스터에 참여하는 것을 방지
- SNID (StorageNodeID)
  - Varlog cluster 안에서 SN을 식별할 수 있는 고유한 식별자
  - 프로세스 시작 전에 커맨드 라입 옵션, 설정 파일 등으로 지정하거나 프로세스 스스로 랜덤하게 생성
- Data paths
  - 데이터를 저장하는 경로 (여러 개 지정 가능)
  - 주어진 경로 아래에 Log Stream 저장을 위한 서브 디렉토리 생성 (LogStream 등록 참고)

## Storage Node 등록

SN 프로세스는 옵션으로 SNID를 넘겨 받거나 임의로 생성한다. MCL (Management Client)은 등록할 SN의 SNID를 이미 알고 있거나 대상 SN의 GetStorageNodeID RPC를 사용하여  알아낸다. 
MCL이 MR (Metadata Repository)에 해당 SN을 등록한 후에야 다른 CL (Client)들이 SN의 존재를 알 수 있고, Log를 읽거나 쓸 수 있다. 또한 MR은 등록된 SN에게만 GetReport를 요청한다.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU05cbnBhcnRpY2lwYW50IE1SXG5cblNOLT4-U046IFN0YXJ0XG5NQ0wtPj4rU046IEdldFN0b3JhZ2VOb2RlSURcblNOLS0-Pi1NQ0w6IFNOSURcbk1DTC0-PitNUjogUmVnaXN0ZXJTdG9yYWdlTm9kZShDSUQsIFNOSUQsIERpc2tJbmZvcywgLi4uKVxuTVItLT4-LU1DTDogT0tcbk1SLT4-K1NOOiBHZXRSZXBvcnRcblNOLS0-Pi1NUjogUmVwb3J0IiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU05cbnBhcnRpY2lwYW50IE1SXG5cblNOLT4-U046IFN0YXJ0XG5NQ0wtPj4rU046IEdldFN0b3JhZ2VOb2RlSURcblNOLS0-Pi1NQ0w6IFNOSURcbk1DTC0-PitNUjogUmVnaXN0ZXJTdG9yYWdlTm9kZShDSUQsIFNOSUQsIERpc2tJbmZvcywgLi4uKVxuTVItLT4-LU1DTDogT0tcbk1SLT4-K1NOOiBHZXRSZXBvcnRcblNOLS0-Pi1NUjogUmVwb3J0IiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)

2번 GetStorageNodeID는 생략 가능한 RPC이다. MCL이 MR에게 SN을 등록하기 위해서 SNID가 필요하다. 2번 과정은 SNID를 알아내기 위한 것이지만, 일반적으로 MCL은 이미 SN에 대한 많은 정보를 알고 있다.

## Log Stream 등록

LS (Log Stream)는 분산 저장된 로그의 부분을 추상화한다. Availability를 위해 LS는 여러 SN에 복제된다(이 문서에서 LS는 로그의 일부분을 의미하는 개념과 SN에 복제된 일부분을 의미하는 개념으로 모두 쓰인다). MCL은 SN에 AddLogStream RPC를 사용하여 새로운 LS를 생성한다. 이때 MCL은 LS에게 고유한 LSID (LogStreamID)를 부여하고 LS 데이터를 저장할 디렉토리를 지정한다. 이 디렉토리는 SN 생성 과정에서 지정한 데이터 경로 중 하나의 서브 디렉토리이다 (일반적으로 지정된 경로 아래에 LSID 이름으로 생성된 서브 디렉토리를 사용한다).

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IE1SXG5cbk1DTC0-PitNUjogR2V0TWV0YWRhdGFcbk1SLT4-LU1DTDogTWV0YWRhdGFcblxuTUNMLT4-TUNMOiBHZW5lcmF0ZSBMU0lEXG5cbk1DTC0-PitTTjE6IEFkZExvZ1N0cmVhbShDSUQsIFNOSUQsIExTSUQsIFBhdGgpXG5TTjEtLT4-LU1DTDogT0tcblxuTUNMLT4-K1NOMjogQWRkTG9nU3RyZWFtKENJRCwgU05JRCwgTFNJRCwgUGF0aClcblNOMi0tPj4tTUNMOiBPS1xuXG5NQ0wtPj4rTVI6IFJlZ2lzdGVyTG9nU3RyZWFtKENJRCwgTFNJRCwgU05JRHMsIFBhdGhzKVxuTVItLT4-LU1DTDogT0siLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IE1SXG5cbk1DTC0-PitNUjogR2V0TWV0YWRhdGFcbk1SLT4-LU1DTDogTWV0YWRhdGFcblxuTUNMLT4-TUNMOiBHZW5lcmF0ZSBMU0lEXG5cbk1DTC0-PitTTjE6IEFkZExvZ1N0cmVhbShDSUQsIFNOSUQsIExTSUQsIFBhdGgpXG5TTjEtLT4-LU1DTDogT0tcblxuTUNMLT4-K1NOMjogQWRkTG9nU3RyZWFtKENJRCwgU05JRCwgTFNJRCwgUGF0aClcblNOMi0tPj4tTUNMOiBPS1xuXG5NQ0wtPj4rTVI6IFJlZ2lzdGVyTG9nU3RyZWFtKENJRCwgTFNJRCwgU05JRHMsIFBhdGhzKVxuTVItLT4-LU1DTDogT0siLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)

1번 과정은 LS 생성에 필요한 정보, 즉 가용한 SN과 이미 존재하는 SNID 등에 대한 정보를 얻기 위한 생략 가능한 과정이다. SN에 LS를 생성하는 4번, 6번 과정은 동시에 진행이 가능하다. 
SN마다 최적의 LS 수가 있을 수 있다. 이를 위해 아래와 같은 방법과 제한점이 있다. 전체 성능과 복작도를 고려하여 MCL과 MR에서 SN 당 LS 수를 제어할 수 있도록 하는 접근법이 필요하다 (Open Question)

- MCL이 하나의 SN에 너무 많은 LS가 생성되지 않도록 AddLogStream을 주의해서 호출
  - MCL의 Fail 및 여러 MCL이 경쟁하는 경우 문제 발생
- MR이 RegisterLogStream 호출받으면 하나의 SN에 정해진 LS 수를 넘지 않도록 제어
  - MR은 시스템의 전체 성능에 영향을 줄 수 있으므로 기능을 최소화하는 것이 바람직함
- SN이 AddLogStream 호출받으면 정해진 LS 수를 넘지 않도록 제어
  - AddLogStream은 SN 로컬에 해당 LS에 대한 자료구조와 실행 컨텍스트를 생성하지만 클러스터 측면에서 유효한 LS 인지 아닌지를 판단할 수 없음

### MCL crash

MCL이 LS 생성하는 중간에 장애가 발생할 수 있다. MR에 등록되지 않은 LS는 Log 읽기/쓰기 명령을 받을 수 없으므로 문제되지 않는다. MCL이 복구되면 다시 LS를 새롭게 생성하면 된다. MCL은 주기적으로 SN들의 상태를 관찰하고 zombie LS를 삭제한다. 

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IE1SXG5cbk1DTC0-PitTTjE6IEFkZExvZ1N0cmVhbShMU0lEMSlcblNOMS0tPj4tTUNMOiBPS1xuXG5NQ0wtPj5NQ0w6IEZhaWx1cmUgcmVjb3ZlcnlcblxuTUNMLT4-K1NOMTogQWRkTG9nU3RyZWFtKExTSUQyKVxuU04xLS0-Pi1NQ0w6IE9LXG5cbk1DTC0-PitTTjI6IEFkZExvZ1N0cmVhbShMU0lEMilcblNOMi0tPj4tTUNMOiBPS1xuXG5NQ0wtPj4rTVI6IFJlZ2lzdGVyTG9nU3RyZWFtKENJRCwgTFNJRCwgU05JRHMsIFBhdGhzKVxuTVItLT4-LU1DTDogT0tcblxuTUNMLT4-K1NOMTogR2V0SW5mb1xuU04xLS0-Pi1NQ0w6IEluZm9cbk1DTC0-PitTTjE6IFJlbW92ZUxvZ1N0cmVhbShMU0lEMSlcblNOMS0tPj4tTUNMOiBPSyIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IE1SXG5cbk1DTC0-PitTTjE6IEFkZExvZ1N0cmVhbShMU0lEMSlcblNOMS0tPj4tTUNMOiBPS1xuXG5NQ0wtPj5NQ0w6IEZhaWx1cmUgcmVjb3ZlcnlcblxuTUNMLT4-K1NOMTogQWRkTG9nU3RyZWFtKExTSUQyKVxuU04xLS0-Pi1NQ0w6IE9LXG5cbk1DTC0-PitTTjI6IEFkZExvZ1N0cmVhbShMU0lEMilcblNOMi0tPj4tTUNMOiBPS1xuXG5NQ0wtPj4rTVI6IFJlZ2lzdGVyTG9nU3RyZWFtKENJRCwgTFNJRCwgU05JRHMsIFBhdGhzKVxuTVItLT4-LU1DTDogT0tcblxuTUNMLT4-K1NOMTogR2V0SW5mb1xuU04xLS0-Pi1NQ0w6IEluZm9cbk1DTC0-PitTTjE6IFJlbW92ZUxvZ1N0cmVhbShMU0lEMSlcblNOMS0tPj4tTUNMOiBPSyIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)

4번에서 MCL은 1번에서 사용한 LSID를 알 수 없다면 새로운 LSID를 이용하여 LS를 생성할 수 있다. MR에 등록되지 않은 LS는 시스템에 부하를 주지 않으며, 주기적인 감시를 통해 삭제할 수 있다 (12번 과정).

## Seal

LS가 정상 작동 하지 못하는 경우, 예를 들면 Replication을 할 수 없을 때 해당 LS는 Seal된다. Seal된 LS는 append를 수행할 수 없다. SN의 LS에 장애가 발생하여 데이터 쓰기를 더 이상 진행할 수 없을 때, 즉 Seal이 되어야 할 때 SN은 스스로 MR에게 Seal을 요청하지 않는다. MR에게 Varlog 클러스터의 상태를 변경하도록 요청하는 것은 MCL만이 진행한다.
MCL은 주기적인 Heartbeat을 사용해 SN들의 상태를 모니터링한다. 즉, MCL의 Heartbeat 메시지의 interval은 SN의 문제를 파악하고 Seal을 진행하는 interval이 된다. Seal을 늦게 진행하면 일부 CL들의 append 응답 시간에 나쁜 영향을 줄 수 있다. 이에 대한 개선이 필요하다 (TODO).

- CL의 Append 요청에 적절한 타임아웃 적용 (expected append response time < timeout < T)
- MR.GetMetadata RPC에 Blacklist 를 공유하고, 응답 Metadata에 최근에 공유받은 Blacklist를 첨부
- SN 스스로 MR에 Seal RPC 호출
- Speculative execution ? (특정 애플리케이션에서만...)

### Primary SN failure

Primary SN에 장애가 발생하여 Append RPC를 수행할 수 없는 경우가 있다. CL은 문제가 발생한 LS 혹은 SN을 블랙리스트에 추가하여 다음 RPC에서 해당 SN 혹은 LS를 배제한다. (TODO: SetBlacklist는 SN, LS등에 대해 동작 가능하며 Blacklist에 등록하기 위한 임계치 설정이 필요하다)

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IENMXG5wYXJ0aWNpcGFudCBNQ0xcbnBhcnRpY2lwYW50IFNOMVxucGFydGljaXBhbnQgU04yXG5wYXJ0aWNpcGFudCBNUlxuXG5DTC0-PlNOMTogQXBwZW5kXG5Ob3RlIHJpZ2h0IG9mIFNOMTogRmFpbHVyZVxuQ0wtPj5DTDogU2V0QmxhY2tsaXN0KFNOMSlcblxuTUNMLT4-U04xOiBIZWFydGJlYXRcbk5vdGUgb3ZlciBNQ0wsU04xOiBmYWlsXG5NQ0wtPj5NQ0w6IFRyaWdnZXIgc2VhbGluZ1xuTUNMLT4-K01SOiBTZWFsKENJRCwgTFNJRClcbk1SLS0-Pi1NQ0w6IExhc3QgQ29tbWl0dGVkIExTTlxuXG5NQ0wtPj4rU04yOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04yLS0-Pi1NQ0w6IFNFQUxJTkcgKG9yIFNFQUxFRCksIExTTlxuXG5DTC0-PitNUjogR2V0TWV0YWRhdGEoKVxuTVItLT4-LUNMOiBNZXRhZGF0YSIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IENMXG5wYXJ0aWNpcGFudCBNQ0xcbnBhcnRpY2lwYW50IFNOMVxucGFydGljaXBhbnQgU04yXG5wYXJ0aWNpcGFudCBNUlxuXG5DTC0-PlNOMTogQXBwZW5kXG5Ob3RlIHJpZ2h0IG9mIFNOMTogRmFpbHVyZVxuQ0wtPj5DTDogU2V0QmxhY2tsaXN0KFNOMSlcblxuTUNMLT4-U04xOiBIZWFydGJlYXRcbk5vdGUgb3ZlciBNQ0wsU04xOiBmYWlsXG5NQ0wtPj5NQ0w6IFRyaWdnZXIgc2VhbGluZ1xuTUNMLT4-K01SOiBTZWFsKENJRCwgTFNJRClcbk1SLS0-Pi1NQ0w6IExhc3QgQ29tbWl0dGVkIExTTlxuXG5NQ0wtPj4rU04yOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04yLS0-Pi1NQ0w6IFNFQUxJTkcgKG9yIFNFQUxFRCksIExTTlxuXG5DTC0-PitNUjogR2V0TWV0YWRhdGEoKVxuTVItLT4-LUNMOiBNZXRhZGF0YSIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)

MR은 Seal RPC가 호출되면 다른 것과 동일하게 RAFT를 통해 적용한다 (5). 즉, Seal 이전에 받은 Report는 Commit이 수행되고, Seal 이후에 받은 Report에 있는 새로운 Commit 요청은 무시된다. MR은 Seal RPC의 응답으로 Last Committed LSN (Log Sequence Number: GLSN or LLSN)을 MCL에게 보낸다. Last Committed LSN은 해당 LS가 Seal되기 전까지 Commit에 성공한 데이터이다. 
MCL은 LS를 구성하는 각 SN에게 Seal RPC를 호출하는데, 이때 MR에게 받은 Last Committed LSN을 같이 보낸다. Seal RPC를 받은 LS는 자신의 상태를 SEALING 혹은 SEALED로 변경하고 Last Committed LSN 보다 큰 LSN에 저장된 uncommitted log entries를 지운다 (Last Committed LSN보다 큰 Committed Log Entry가 있을 수 없다).
CL은 주기적으로 MR의 GetMetadata RPC를 호출하여 클러스터 구성 정보를 갱신한다. 이를 통해서 Seal된 SN들에 대한 정보를 얻고 이를 피하여 Append 요청을 한다.

### Backup SN failure

SN1은 로그의 복제 과정에서 Backup SN의 failure를 알아챌 수 있다. 이런 경우 SN1의 LS는 스스로 SEALING 상태로 전환하고, Append 요청은 실패처리 한다 (ErrSealed). MCL은 주기적인 Hearbeat을 통해 SN1이 Seal되었음을 알게 되고, MR에게 Seal RPC 요청을 한다. 이후 MR에게 받은 Last Committed LSN을 파라미터로 각 SN에게 Seal RPC를 호출하는 과정은 위와 동일하다.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IENMXG5wYXJ0aWNpcGFudCBNQ0xcbnBhcnRpY2lwYW50IFNOMVxucGFydGljaXBhbnQgU04yXG5wYXJ0aWNpcGFudCBNUlxuXG5DTC0-PitTTjE6IEFwcGVuZFxuU04xLT4-U04yOiBSZXBsaWNhdGVcbk5vdGUgcmlnaHQgb2YgU04yOiBGYWlsdXJlXG5TTjEtPj5TTjE6IFNFQUxJTkdcblNOMS0tPj4tQ0w6IEVyclNlYWxlZFxuQ0wtPj5DTDogU2V0QmxhY2tsaXN0KFNOMSlcblxuTUNMLT4-K1NOMTogSGVhcnRiZWF0XG5TTjEtLT4-LU1DTDogRXJyU2VhbGVkXG5cbk1DTC0-PitNUjogU2VhbChDSUQsIExTSUQpXG5NUi0tPj4tTUNMOiBMYXN0IENvbW1pdHRlZCBMU05cblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMSU5HIChvciBTRUFMRUQpLCBMU05cblxuTUNMLT4-K1NOMjogU2VhbChDSUQsIExTSUQsIExTTilcblNOMi0tPj4tTUNMOiBTRUFMSU5HIChvciBTRUFMRUQpLCBMU04iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IENMXG5wYXJ0aWNpcGFudCBNQ0xcbnBhcnRpY2lwYW50IFNOMVxucGFydGljaXBhbnQgU04yXG5wYXJ0aWNpcGFudCBNUlxuXG5DTC0-PitTTjE6IEFwcGVuZFxuU04xLT4-U04yOiBSZXBsaWNhdGVcbk5vdGUgcmlnaHQgb2YgU04yOiBGYWlsdXJlXG5TTjEtPj5TTjE6IFNFQUxJTkdcblNOMS0tPj4tQ0w6IEVyclNlYWxlZFxuQ0wtPj5DTDogU2V0QmxhY2tsaXN0KFNOMSlcblxuTUNMLT4-K1NOMTogSGVhcnRiZWF0XG5TTjEtLT4-LU1DTDogRXJyU2VhbGVkXG5cbk1DTC0-PitNUjogU2VhbChDSUQsIExTSUQpXG5NUi0tPj4tTUNMOiBMYXN0IENvbW1pdHRlZCBMU05cblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMSU5HIChvciBTRUFMRUQpLCBMU05cblxuTUNMLT4-K1NOMjogU2VhbChDSUQsIExTSUQsIExTTilcblNOMi0tPj4tTUNMOiBTRUFMSU5HIChvciBTRUFMRUQpLCBMU04iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)

### Log I/O falut

Log I/O 가 발생했을 때도 스스로 Seal하는 과정 (SEALING 상태로 변경)을 거친다. MCL이 MR에게 Last Committed LSN을 얻고 각 SN의 Seal RPC를 호출하는 것은 동일하다.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IENMXG5wYXJ0aWNpcGFudCBNQ0xcbnBhcnRpY2lwYW50IFNOMVxucGFydGljaXBhbnQgU04yXG5wYXJ0aWNpcGFudCBNUlxuXG5DTC0-PitTTjE6IEFwcGVuZFxuU04xLT4-U04xOiBJTyBmYXVsdFxuU04xLT4-U04xOiBTRUFMSU5HXG5TTjEtLT4-LUNMOiBFcnJTZWFsZWRcbkNMLT4-Q0w6IFNldEJsYWNrbGlzdChTTjEsIExTKVxuXG5NQ0wtPj4rU04xOiBIZWFydGJlYXRcblNOMS0tPj4tTUNMOiBFcnJTZWFsZWRcblxuTUNMLT4-K01SOiBTZWFsKENJRCwgTFNJRClcbk1SLS0-Pi1NQ0w6IExhc3QgQ29tbWl0dGVkIExTTlxuXG5NQ0wtPj4rU04yOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04yLS0-Pi1NQ0w6IFNFQUxJTkcgKG9yIFNFQUxFRCksIExTTlxuXG5NQ0wtPj4rU04xOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04xLS0-Pi1NQ0w6IFNFQUxJTkcgKG9yIFNFQUxFRCksIExTTlxuXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IENMXG5wYXJ0aWNpcGFudCBNQ0xcbnBhcnRpY2lwYW50IFNOMVxucGFydGljaXBhbnQgU04yXG5wYXJ0aWNpcGFudCBNUlxuXG5DTC0-PitTTjE6IEFwcGVuZFxuU04xLT4-U04xOiBJTyBmYXVsdFxuU04xLT4-U04xOiBTRUFMSU5HXG5TTjEtLT4-LUNMOiBFcnJTZWFsZWRcbkNMLT4-Q0w6IFNldEJsYWNrbGlzdChTTjEsIExTKVxuXG5NQ0wtPj4rU04xOiBIZWFydGJlYXRcblNOMS0tPj4tTUNMOiBFcnJTZWFsZWRcblxuTUNMLT4-K01SOiBTZWFsKENJRCwgTFNJRClcbk1SLS0-Pi1NQ0w6IExhc3QgQ29tbWl0dGVkIExTTlxuXG5NQ0wtPj4rU04yOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04yLS0-Pi1NQ0w6IFNFQUxJTkcgKG9yIFNFQUxFRCksIExTTlxuXG5NQ0wtPj4rU04xOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04xLS0-Pi1NQ0w6IFNFQUxJTkcgKG9yIFNFQUxFRCksIExTTlxuXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)

## Sync

Seal된 LS가 다시 Append를 수행하기 위해서는 Unseal되어야 한다. 하지만 특정 LS 복제본에 Commit된 로그가 Last Committed LSN보다 작다면 Unseal될 수 없다. LS를 구성하는 모든 복제본들이 필요한 Last Committed LSN까지의 로그를 저장하도록 하는 것이 Sync이다.
Sync RPC는 SEALED 상태의 LS가 SEALING 상태의 LS에게 자신의 로그를 복사하도록 한다. 즉, SEALED 상태가 아닌 LS는 Sync RPC를 수행할 수 없다.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExTTlxuXG5NQ0wtPj5TTjI6IFNlYWwoQ0lELCBMU0lELCBMU04pXG5Ob3RlIG92ZXIgTUNMLFNOMjogRXJyb3JcblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExTTlxuXG5NQ0wtPj5TTjI6IFNlYWwoQ0lELCBMU0lELCBMU04pXG5Ob3RlIG92ZXIgTUNMLFNOMjogRXJyb3JcblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExTTlxuXG5NQ0wtPj4rU04yOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04yLS0-Pk1DTDogU0VBTElORywgTFNOXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExTTlxuXG5NQ0wtPj5TTjI6IFNlYWwoQ0lELCBMU0lELCBMU04pXG5Ob3RlIG92ZXIgTUNMLFNOMjogRXJyb3JcblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExTTlxuXG5NQ0wtPj5TTjI6IFNlYWwoQ0lELCBMU0lELCBMU04pXG5Ob3RlIG92ZXIgTUNMLFNOMjogRXJyb3JcblxuTUNMLT4-K1NOMTogU2VhbChDSUQsIExTSUQsIExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExTTlxuXG5NQ0wtPj4rU04yOiBTZWFsKENJRCwgTFNJRCwgTFNOKVxuU04yLS0-Pk1DTDogU0VBTElORywgTFNOXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)



새롭게 추가된 LS는 MCL의 Seal RPC를 받으면 RUNNING 상태에서 SEALING 상태로 변경된다. Sync는 오래 걸릴 수 있는 작업이므로 Asyncrhonous하게 동작하며, MCL은 Sync 작업 상태를 polling 하면 묻는다. 만약 SN2가 같은 LS에 대해 SN1과 SN3으로 부터 SyncReplicate RPC를 요청받는다면 나중에 들어온 요청은 무시해야 한다 (8번). 

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IFNOM1xuXG5NQ0wtPj4rU04xOiBTZWFsKENJRCwgTFNJRCwgTExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExMU04oMTApXG5cbk1DTC0-PitTTjI6IFNlYWwoQ0lELCBMU0lELCBMTFNOKVxuU04yLS0-Pi1NQ0w6IFNFQUxJTkcsIExMU04oTlVMTClcblxuTUNMLT4-K1NOMTogU3luYyhDSUQsIExTSUQsIExMU04sIFNOMiwgLi4uKVxuU04xLS0-Pi1NQ0w6IFNZTkNfSU5QUk9HUkVTU1xuXG5TTjEtPj4rU04yOiBTeW5jUmVwbGljYXRlXG5TTjMtPj4rU04yOiBTeW5jUmVwbGljYXRlXG5TTjItPj4tU04zOiBFcnJBbHJlYWR5U3luY1xuTUNMLT4-K1NOMTogU3luYyhDSUQsIExTSUQsIExMU04sIFNOMiwgLi4uKVxuU04xLS0-Pi1NQ0w6IFNZTkNfSU5QUk9HUkVTU1xuTUNMLT4-K1NOMTogU3luYyhDSUQsIExTSUQsIExMU04sIFNOMiwgLi4uKVxuU04xLS0-Pi1NQ0w6IFNZTkNfSU5QUk9HUkVTU1xuU04yLS0-Pi1TTjE6IE9LXG5cbk1DTC0-PitTTjE6IFN5bmMoQ0lELCBMU0lELCBMTFNOLCBTTjIsIC4uLilcblNOMS0tPj4tTUNMOiBTWU5DX0RPTkVcblxuTUNMLT4-K1NOMjogU2VhbChDSUQsIExTSUQsIExMU04pXG5TTjItLT4-LU1DTDogU0VBTEVELCBMTFNOKDEwKSIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IFNOM1xuXG5NQ0wtPj4rU04xOiBTZWFsKENJRCwgTFNJRCwgTExTTilcblNOMS0tPj4tTUNMOiBTRUFMRUQsIExMU04oMTApXG5cbk1DTC0-PitTTjI6IFNlYWwoQ0lELCBMU0lELCBMTFNOKVxuU04yLS0-Pi1NQ0w6IFNFQUxJTkcsIExMU04oTlVMTClcblxuTUNMLT4-K1NOMTogU3luYyhDSUQsIExTSUQsIExMU04sIFNOMiwgLi4uKVxuU04xLS0-Pi1NQ0w6IFNZTkNfSU5QUk9HUkVTU1xuXG5TTjEtPj4rU04yOiBTeW5jUmVwbGljYXRlXG5TTjMtPj4rU04yOiBTeW5jUmVwbGljYXRlXG5TTjItPj4tU04zOiBFcnJBbHJlYWR5U3luY1xuTUNMLT4-K1NOMTogU3luYyhDSUQsIExTSUQsIExMU04sIFNOMiwgLi4uKVxuU04xLS0-Pi1NQ0w6IFNZTkNfSU5QUk9HUkVTU1xuTUNMLT4-K1NOMTogU3luYyhDSUQsIExTSUQsIExMU04sIFNOMiwgLi4uKVxuU04xLS0-Pi1NQ0w6IFNZTkNfSU5QUk9HUkVTU1xuU04yLS0-Pi1TTjE6IE9LXG5cbk1DTC0-PitTTjE6IFN5bmMoQ0lELCBMU0lELCBMTFNOLCBTTjIsIC4uLilcblNOMS0tPj4tTUNMOiBTWU5DX0RPTkVcblxuTUNMLT4-K1NOMjogU2VhbChDSUQsIExTSUQsIExMU04pXG5TTjItLT4-LU1DTDogU0VBTEVELCBMTFNOKDEwKSIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)

## Unseal

SN에게 Unseal RPC를 호출하면 성공/실패 결과와 현재 상태를 반환한다.

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IE1SXG5cbk1DTC0-PitTTjE6IFVuc2VhbChDSUQsIExTSUQpXG5TTjEtLT4-LU1DTDogT0ssIFJVTk5JTkdcblxuTUNMLT4-K1NOMjogVW5zZWFsKENJRCwgTFNJRClcblNOMi0tPj4tTUNMOiBPSywgUlVOTklOR1xuXG5NQ0wtPj4rTVI6IFVuc2VhbChDSUQsIExTSUQpXG5NUi0tPj4tTUNMOiBPSyIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5hdXRvbnVtYmVyXG5cbnBhcnRpY2lwYW50IE1DTFxucGFydGljaXBhbnQgU04xXG5wYXJ0aWNpcGFudCBTTjJcbnBhcnRpY2lwYW50IE1SXG5cbk1DTC0-PitTTjE6IFVuc2VhbChDSUQsIExTSUQpXG5TTjEtLT4-LU1DTDogT0ssIFJVTk5JTkdcblxuTUNMLT4-K1NOMjogVW5zZWFsKENJRCwgTFNJRClcblNOMi0tPj4tTUNMOiBPSywgUlVOTklOR1xuXG5NQ0wtPj4rTVI6IFVuc2VhbChDSUQsIExTSUQpXG5NUi0tPj4tTUNMOiBPSyIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)

