# Storage Node Client

Storage Node와 통신하기 위해서 `StorageNodeClient`가 필요하다. Varlog Library를
사용하여 로그를 저장하고 읽기 위해서는 여러 Storage Node에 연결하여 동작해야
한다. 아래 그림은 Storage Node에 연결하여 동작하기 위한 `StorageNodeClient`와
Storage Node의 동작이 구현된 `StorageNodeService`의 구성을 간단하게 표현한다.

    +----------------------+
    |Varlog Client Library |
    |                      |
    | +------------------+ |         +----------------------+
    | |StorageNodeClient | |         |  StorageNodeService  |
    | |                  | |         |                      |
    | | +--------------+ | |         | +------------------+ |
    | | |     RPC      |<+-+---------+>|       RPC        | |
    | | +--------------+ | |         | +------------------+ |
    | +------------------+ |         +----------------------+
    | +------------------+ |         +----------------------+
    | |StorageNodeClient | |         |  StorageNodeService  |
    | |                  | |         |                      |
    | | +--------------+ | |         | +------------------+ |
    | | |     RPC      |<+-+---------+>|       RPC        | |
    | | +--------------+ | |         | +------------------+ |
    | +------------------+ |         +----------------------+
    |          .           |                    .
    |          .           |                    .
    |          .           |                    .
    | +------------------+ |         +----------------------+
    | |StorageNodeClient | |         |  StorageNodeService  |
    | |                  | |         |                      |
    | | +--------------+ | |         | +------------------+ |
    | | |     RPC      |<+-+---------+>|       RPC        | |
    | | +--------------+ | |         | +------------------+ |
    | +------------------+ |         +----------------------+
    +----------------------+

## RPC
RPC는 gRPC를 기반으로 작성되었다. `Append`, `Read`, `Subscribe`, `Trim` API들은
모두 gRPC를 사용해 구현한다.

# Storage Node
Storage Node 구조는 아래와 같다. 각 RPC 서비스들은 서로 다른 API들을 노출한다.
`StorageNodeService`는 `Append`, `Read`, `Trim`, `Subscribe`와 같은 기본적인
API들을 제공한다. `ReplicatorService`는 Primary/Backup 방식의 Log Entry 복제를
한다. `LogStreamReporterService`는 MR의 요청에 따라 SN에 있는 LS들의 uncommitted
log entry 정보를 제공한다.

          +----------------------------+
          |     MetadataRepository     |
          | +------------------------+ |
         ++>|LogStreamReporterClient |<+-----report/commit-------------------------------------+
         || +------------------------+ |                                                       |
         |+----------------------------+                                                       |
    report/commit                                                                              |
         |    +----------------------------+       +-----------------+                         |
         |    |            RPCs            |       |                 |    +---------------+    |
         |    |                            |  +--->|LogStreamExecutor|--->|    Storage    |    |
         |    | +------------------------+ |  |    |                 |    +---------------+    |
         |    | |   StorageNodeService   | |  |    +-----------------+                         |
         |    | +------------------------+ |  |                                                |
         |    |                            |  |    +-----------------+                         |
         |    | +------------------------+ |  |    |                 |    +---------------+    |
      +-------->|   ReplicatorService    | |  +--->|LogStreamExecutor|--->|    Storage    |    |
      |  |    | +------------------------+ |  |    |                 |    +---------------+    |
      |  |    |                            |  |    +-----------------+                         |
      |  |    | +------------------------+ |  |                                                |
      |  +----+>|LogStreamReporterService| |  |    +-----------------+                         |
      |       | +------------------------+ |  |    |                 |    +---------------+    |
      |       |              ^             |  +--->|LogStreamExecutor|--->|    Storage    |    |
      |       +--------------|-------------+  |    |                 |    +---------------+    |
      |                      v                |    +-----------------+                         |
      |         +------------------------+    |                                                |
      |         |   LogStreamReporter    |<---+                                                |
      |         +------------------------+                                                     |
      |                                                                                        |
      +-------------------------replication--+                                                 |
                                             |                                                 |
                                    +-----------------+       +----------------------------+   |
               +---------------+    |                 |       |            RPCs            |   |
               |    Storage    |<---|LogStreamExecutor|<---+  |                            |   |
               +---------------+    |                 |    |  | +------------------------+ |   |
                                    +-----------------+    |  | |   StorageNodeService   | |   |
                                                           |  | +------------------------+ |   |
                                    +-----------------+    |  |                            |   |
               +---------------+    |                 |    |  | +------------------------+ |   |
               |    Storage    |<---|LogStreamExecutor|<---+  | |   ReplicatorService    | |   |
               +---------------+    |                 |    |  | +------------------------+ |   |
                                    +-----------------+    |  |                            |   |
                                                           |  | +------------------------+ |   |
                                    +-----------------+    |  | |LogStreamReporterService|<+---+
               +---------------+    |                 |    |  | +------------------------+ |
               |    Storage    |<---|LogStreamExecutor|<---+  |              ^             |
               +---------------+    |                 |    |  +--------------|-------------+
                                    +-----------------+    |                 v
                                                           |    +------------------------+
                                                           +--->|   LogStreamReporter    |
                                                                +------------------------+


