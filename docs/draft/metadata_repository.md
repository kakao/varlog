- Authors: pharrell.jang
- Status:
- Reviewer: jun.song
- Date: 2020-06-11

# Metadata Repository (a.k.a Order Layer)
## Terminology
- MR: Metadata Repository
- SN: Storage Node
- LS: Log Stream
- GLSN: Global Log Sequence Number

## Overview
MR은 cluster에 존재하는 모든 Log Stream의 정보를 저장하며, client가 log append할수
있도록 정보를 제공한다. MR은 주기적으로 모든 SN에게 report를 요구하고 수집된
report를 바탕으로 GLSN를 발급한다. 또한 report를 통해 LS 상태, SN의 상태를 수집할
수 있다. SN은 report 시점에 모든 local log stream의 position을 보고한다. MR은 모든
SN 의 report 정보를 수집하여, replication이 완료된 position으로 global commit 하여
GLSN을 발급한다. MR이 SN으로 부터 LS의 정보를 받아 GLSN을 발급하는 과정은 다음과 같다.

                            +-------------------------------------------------------------+
                            |                             MR                              |
                            +---+------+----------------+------+---------------+------+---+
                                ^      |                ^      |               ^      |
                    3.report    |      |   3.report     |      |   3.report    | 4.global
                      (3,2.2)   |      |     (2,4,2)    |      |     (2,3,2)   |   commit
                                |      |4.global commit |      |4.global commit|   (2,2,2)
                                |      |  (2,2,2)       |      |  (2,2,2)      |      |
                                |      v                |      v               |      v
                            +---+------+---+        +---+------+---+       +---+------+---+
                            |              |        |              |       |              |
                            |              |        |              |       |              |
        +----+ 1.APPEND,b +- Log Stream 1 --------------------------------------------------+
        |    +----------->| |+------------+| 2.a,b  |+------------+| 2.a,b |+------------+| |
        |Cl 1| 5.ACK,l=2  | ||Primary 1   +--------->+Backup 1    +-------->+Backup 1    || |
        |    +<--------------+Log: a,b,c  ||        ||Log: a,b    ||       ||Log: a,b    || |
        +----+       +--->| |+------------+|        |+------------+|       |+------------+| |
                     |    +-----------------------------------------------------------------+
                     |      |              |        |              |       |              |
                     |    -------------------+    +- Log Stream 2 ---------------------------
                     |      |+------------+| |    | |+------------+|       |+------------+|
        +----+       |      ||Backup 2    || |    | ||Primary 2   ||       ||Backup 2    ||
        |Cl 2+-------+      ||Log: d,e    || |    | ||Log: d,e,f,g||       ||Log: d,e,f  ||
        |    |  1.APPEND,c  |+------------+| |    | |+------------+|       |+------------+|
        +----+            -------------------+    +------------------------------------------
                            |              |        |              |       |              |
                          -------------------------------------------+   +- Log Stream 3 ----
                            |+------------+|        |+------------+| |   | |+------------+|
                            ||Backup 3    ||        ||Backup 3    || |   | ||Primary 3   ||
                            ||Log: h,i    ||        ||Log: h,i    || |   | ||Log: h,i    ||
                            |+------------+|        |+------------+| |   | |+------------+|
                          -------------------------------------------+   +-------------------
                            |              |        |              |       |              |
                            |              |        |              |       |              |
                            +--------------+        +--------------+       +--------------+
                                  SN 1                    SN 2                   SN 3


### Masterless Global Commit
MR은 1대 이상의 노드가 Raft로 구성된 저장소이다. MR의 각 노드는 각자 할당받은 SN에
대하여 Report를 수집하여 raft를 통해 공유한다. Raft의 Leader는 주기적으로 Commit
메시지을 생성하여, raft를 통해 발급한다. Commit 메시지를 받은 노드는 각자 가지고 있는
report를 이용하여 각자 Global Commit 작업을 수행한다. Report와 Commit 메시지는 모두
global order를 지키므로 모든 노드는 같은 Commit 결과를 갖는다. 각 노드는 자신이
담당한 모든 SN에게 Commit 결과를 전달한다.

         +-----+      +-----+      +-----+      +-----+      +-----+      +-----+
         | MR1 |      | MR2 |      | MR3 |      | SN1 |      | SN2 |      | SN3 |
         +--+--+      +--+--+      +--+--+      +--+--+      +--+--+      +--+--+
            |            |            |            |            |            |
            +<--------------Report1----------------+            |            |
            |            <---------------Report2----------------+            |
            |            |            <---------------Report3----------------+
           +---------------------------+           |            |            |
           | share Report1,2,3 by Raft |           |            |            |
           +---------------------------+           |            |            |
        +-------+        |            |            |            |            |
        |propose+-------->            |            |            |            |
        |commit +--------------------->            |            |            |
        +-------+        |            |            |            |            |
           +---------------------------+           |            |            |
           | share commit msg by Raft  |           |            |            |
           +---------------------------+           |            |            |
        +-------+    +-------+    +-------+        |            |            |
        |commit |    |commit |    |commit |        |            |            |
        |& store|    |& store|    |& store|        |            |            |
        +-------+    +-------+    +-------+        |            |            |
            |            |            |            |            |            |
            +------------Commit Result1------------>            |            |
            |            +------------Commit Result2------------>            |
            |            |            +------------Commit Result3------------>
            |            |            |            |            |            |


Management Cliet(a.k.a Admin) 은 MR에 Storage node 추가/삭제, Storage 추가/삭제,
LS creata/finalize 등을 수행하며, 이를 통해 cluster 내에 일정한 개수의 active
LS가 유지되도록 한다.

## Design
### GLSN 발급
MR은 report를 수집하여 GLSN을 발급한다. MR은 각 SN으로 부터 uncommited log
entry 개수를 수집하여, replicate 완료된 log entry를 개수를 알수 있다. 이미
알고 있는 highest GLSN을 기준으로 LSID 순서대로 GLSN을 부여한다.

        +-Report------------------------------------------------+
        |+-----------------+-----------------+-----------------+|
        || LS#:1           | LS#:1           | LS#:1           ||
        || SN#:1           | SN#:2           | SN#:3           ||
        || NumUncommited:3 | NumUncommited:3 | NumUncommited:3 ||
        |+-----------------+-----------------+-----------------+|
        |                                                       |
        |+-----------------+-----------------+-----------------+|
        || LS#:2           | LS#:2           | LS#:2           ||
        || SN#:4           | SN#:5           | SN#:6           ||
        || NumUncommited:2 | NumUncommited:4 | NumUncommited:3 ||
        |+-----------------+-----------------+-----------------+|
        +-------------------------------------------------------+

         [Known Info]                                  |
         Total Log Stream: 2                           |
         Highest GLSN: 10                              |
                                                       | GLSN calculate
         [Collected Info]                              |      process
         LS1:: NumDurableLogEntry:3,3,3                |
         LS2:: NumDurableLogEntry:4,3,2                |
                                                       |
         [Calculate Info]                              |
         LS1:: NumReplicatedLogEntry:2, GLSN: 11,12,13 |
         LS1:: NumReplicatedLogEntry:2, GLSN: 14,15    v

        +-Result---------------------------------------------------------------+
        |+----------------------+----------------------++---------------------+|
        || LS#:1                | LS#:1                | LS#:1                ||
        || SN#:1                | SN#:2                | SN#:3                ||
        || CommitedGLSNs:[11,13]| CommitedGLSNs:[11,13]| CommitedGLSNs:[11,13]||
        |+----------------------+----------------------+----------------------+|
        |                                                                      |
        |+----------------------+----------------------++---------------------+|
        || LS#:2                | LS#:2                | LS#:2                ||
        || SN#:4                | SN#:5                | SN#:6                ||
        || CommitedGLSNs:[14,15]| CommitedGLSNs:[14,15]| CommitedGLSNs:[14,15]||
        |+----------------------+----------------------+----------------------+|
        +----------------------------------------------------------------------+

MR은 SN으로 부터 지속적으로 report를 수집하며, 서로 다른 MR node가 같은 SN으로
부터 report를 수집 하므로, 이미 발급된 GLSN에 대한 report를 받을 수도 있다.
MR은 이러한 상황에서도 일관된 판단을 내려야 하며, 이를 위해 global commit이
수행될 때 마다 LS별 결과를 유지한다. 이를 통해 중첩된 report 에 대해 일관된
GLSN을 발급할 수 있다. 이를 위해 global commit 시에 발급되는 highest GLSN을
epoch 처럼 사용한다.

        +-----------------------------------------------------------------------+
        |                      LS1               LS2               LS3          |
        |     +--------+-----------------+-----------------+-----------------+  |
        | cut3|Highest | MinGLSN:11      | MinGLSN:13      | MinGLSN:14      |  |
        |     |GLSN:16 | MaxGLSN:12      | MaxGLSN:13      | MaxGLSN:16      |  |
        |     +--------------------------------------------------------------+  |
        | cut2|Highest | MinGLSN:5       | MinGLSN:11      | MinGLSN:8       |  |
        |     |GLSN:10 | MaxGLSN:5       | MaxGLSN:12      | MaxGLSN:10      |  |
        |     +--------------------------------------------------------------+  |
        | cut1|Highest | MinGLSN:1       | MinGLSN:3       | MinGLSN:4       |  |
        |     |GLSN:4  | MaxGLSN:2       | MaxGLSN:3       | MaxGLSN:4       |  |
        |     +--------+-----------+-+---+-----------------+-----------------+  |
        |                          ^ |                                          |
        +-----------------------------------------------------------------------+
                                   | |
               +-----------------+ | |    +-------------------------+
               |SN#:1            +-+ +--->+SN#:1                    |
               |LS#:1            | | |    |LS#:1                    |
               |HighestGLSN:4    | | |    |CommitedGLSNs:[5],[11,12]|
               |NumUncommited:3  | | |    |HighestGLSN:16           |
               +-----------------+ | |    +-------------------------+
                Report From SN1    | |
                                   | |
               +-----------------+ | |    +-------------------------+
               |SN#:1            +-+ +--->+SN#:1                    |
               |LS#:1            |        |LS#:1                    |
               |HighestGLSN:10   |        |CommitedGLSNs:[11,12]    |
               |NumUncommited:2  |        |HighestGLSN:16           |
               +-----------------+        +-------------------------+
                Report From SN1

이 정보는 global commit이 발생할때 마다 각 노드에서 생성됨으로 Raft leader
장애시에도 reader election 외에는 issue가 없다.


### MR Raft Leader Fail
MR은 Raft로 구성된 저장소 이기 때문에 leader 장애시, 새로운 leader 선출
과정을 거친다. Global Commit 정보는 각노드에서 생성 관리하므로 leader 장애시
복구할 필요가 없다.

        +-----+      +-----+      +-----+      +-----+      +-----+      +-----+
        | MR1 |      | MR2 |      | MR3 |      | SN1 |      | SN2 |      | SN3 |
        +--+--+      +--+--+      +--+--+      +--+--+      +--+--+      +--+--+
           |            |            |            |            |            |
           +<--------------Report1----------------+            |            |
           |            <--------------|Report2|---------------+            |
           |            |            <---------------Report3----------------+
         Fail           |            |            |            |            |
          +-+           |            |            |            |            |
          |@|           +-election--->            |            |            |
          |@|           <------vote--+            |            |            |
          |@|      +----------+      |            |            |            |
          |@|      |new leader|      |            |            |            |
          |@|      +----------+      |            |            |            |
          |@|           <-------Report1-----------+            |            |
          |@|           |            <--------Report2----------+            |
          |@|           |            <--------Report3-----------------------+
          |@|          +--------------+           |            |            |
          |@|          | share Report |           |            |            |
          |@|          +--------------+           |            |            |
          |@|       +-------+        |            |            |            |
          |@|       |propose+-------->            |            |            |
          |@|       |commit |        |            |            |            |
          |@|       +-------+        |            |            |            |
          |@|       +-------+    +-------+        |            |            |
          |@|       |commit |    |commit |        |            |            |
          +-+       |& store|    |& store|        |            |            |
           |        +-------+    +-------+        |            |            |
           |            |            |            |            |            |
           +            +            +            +            +            +
