# Storage Node
이 문서에서는 아래와 같은 가정을 한다.

- Client 기반의 Chain Replication 방식을 사용한다.
- Replica의 수는 3개이며, Storage Node 2개가 Fail될때까지 Availability를 유지할
수 있다.

## Append
Client는 Log Entry를 Append하기 위해서 Sequencer에게 GLSN을 발급받는다. GLSN은
Log Entry가 쓰여질 위치이다. 해당 GLSN이 쓰여져야할 Log Stream의 Replica정보는
Client 로컬 Projection 정보를 통해 알아내고, Chain Replication 순서대로 Storage
Node들에 write 요청을 한다. 

    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
         |            |            |            |            |            |
         |            |            |            |            |            |
         <--next:ok--->            |            |            |            |
         |            |            |            |            |            |
         <---write:ok-+------------>            |            |            |
         <---write:ok-+------------+------------>            |            |
         <---write:ok-+------------+------------+------------>            |
         |            |            |            |            |            |
         |            |            |            |            |            |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+

Write가 성공하는 경우 4RTTs RPC가 발생한다.

## Read
Client가 특정 로그 읽기 위해서 먼저 해당 GLSN을 갖고 있는 Log Stream의
Replica들을 알아야한다. 이는 로컬에 저장된 Projection을 통해서 알수 있다. Chain
Replication의 Tail (아래 그림에서는 SN3)에게 읽기 요청을 한다.

    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
         |            |            |            |            |            |
         |            |            |            |            |            |
         <---read:ok--+------------+------------+------------>            |
         |            |            |            |            |            |
         |            |            |            |            |            |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+

Read가 성공하는 경우 1RTT RPC가 발생한다.

## Failures

### Chain의 Head가 Fail한 경우


    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
         |            |            |            |            |            |
         |            |            |            |            |            |
         <--next:ok--->            |            |            |            |
         |            |            |            |            |            |
         +-write:error+-------->   |            |            |            |
        +++           |            |            |            |            |
        | duration to decide if SN1 fails       |            |            |
        | and CL triggers reconfiguration       |            |            |
        | |           |            |            |            |            |
        +++           |            |            |            |            |
      +----------------------------------------------------------------------+
      |reconfiguration|            |            |            |            |  |
      |  +------------+------------>            |            |            |  |
      |  <------------+------------+------------>            |            |  |
      |  <------------+------------+------------+------------>            |  |
      |  <------------+------------+------------+------------+------------>  |
      +----------------------------------------------------------------------+
         |            |            |            |            |            |
         |            |            |            |            |            |
         |            |            |            |            |            |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+

위 그림은 SN1에서 SN2를 거쳐 SN3로 이어지는 Chain Replication을 표현한다. 여기서
Chain의 Head, 즉 SN1이 Fail한 경우 CL의 Append 요청은 실패한다. CL은 SN1에
장애가 있음을 판단하고 refconfiguration을 거쳐야 한다. 여기서 두가지 이슈가
있다.

- SN1에 장애가 있음을 확신하기 위한 조건 필요
- Reconfiguration이 짧아야 한다.


