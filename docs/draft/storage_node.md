# Storage Node
이 문서에서는 아래와 같은 가정을 한다.

- Client 기반의 Chain Replication 방식을 사용한다.
- Replica의 수는 3개이며, Storage Node 2개가 Fail될때까지 Availability를 유지할
수 있다.

## Append
Client는 Log Entry를 Append하기 위해서 Sequencer에게 GLSN을 발급받는다. GLSN은
Log Entry가 쓰여질 위치이다. 해당 GLSN이 쓰여져야할 Log Stream의 Replica정보는
Client 로컬 Projection 정보를 통해 알아내고, Chain Replication 순서대로 Storage
Node들에 write 요청을 한다. 

    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
         |            |            |            |            |            |
         |            |            |            |            |            |
         <--next:ok--->            |            |            |            |
         |            |            |            |            |            |
         <---write:ok-+------------>            |            |            |
         <---write:ok-+------------+------------>            |            |
         <---write:ok-+------------+------------+------------>            |
         |            |            |            |            |            |
         |            |            |            |            |            |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+

Write가 성공하는 경우 4RTTs RPC가 발생한다.

## Read
Client가 특정 로그 읽기 위해서 먼저 해당 GLSN을 갖고 있는 Log Stream의
Replica들을 알아야한다. 이는 로컬에 저장된 Projection을 통해서 알수 있다. Chain
Replication의 Tail (아래 그림에서는 SN3)에게 읽기 요청을 한다.

    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
         |            |            |            |            |            |
         |            |            |            |            |            |
         <---read:ok--+------------+------------+------------>            |
         |            |            |            |            |            |
         |            |            |            |            |            |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+

Read가 성공하는 경우 1RTT RPC가 발생한다.

## Failures

### Append failure

#### Chain의 Head가 Fail한 경우

    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
         |            |            |            |            |            |
      epoch=1         |         epoch=1      epoch=1      epoch=1      epoch=1
         |            |            |            |            |            |    <-+
      CR:SN1->SN2->SN3|            |            |            |            |      |
         |            |            |            |            |            |      |
         <--next:ok--->            |            |            |            |      |
         |            |            |            |            |            |      |
         +--write:error-------->   |            |            |            |      |
        +++           |            |            |            |            |      |
        | duration to decide if SN1 fails       |            |            |      |
        | and CL triggers reconfiguration       |            |            |     (a)
        | |           |            |            |            |            |      |
        +++           |            |            |            |            |      |
         |            |            |            |            |            |      |
      +----------------------------------------------------------------------+   |
      |reconfiguration|            |            |            |            |  |   |
      |  +------------+------------>            |            |            |  |   |
      |  <------------+------------+------------>            |            |  |   |
      |  <------------+------------+------------+------------>            |  |   |
      |  <------------+------------+------------+------------+------------>  | <-+
      +----------------------------------------------------------------------+
         |            |            |            |            |            |
      epoch=2         |         failed       epoch=2      epoch=2      epoch=2
         |            |            |            |            |            |    <-+
      CR:SN2->SN3     |            |            |            |            |      |
         |            |            |            |            |            |      |
         <--write:ok--+------------+------------>            |            |      |
         <--write:ok--+------------+------------+------------>            |      |
         |            |            |            |            |            |      |
         |            |            |            |            |            |      |
         +--write:error------------+-------->   |            |            |      |
        +++           |            |            |            |            |      |
        | duration to decide if SN2 fails       |            |            |     (b)
        | and CL triggers reconfiguration       |            |            |      |
        | |           |            |            |            |            |      |
        +++           |            |            |            |            |      |
         |            |            |            |            |            |      |
      +----------------------------------------------------------------------+   |
      |reconfiguration|            |            |            |            |  |   |
      |  +------------+------------>            |            |            |  |   |
      |  <------------+------------+------------>            |            |  |   |
      |  <------------+------------+------------+------------>            |  |   |
      |  <------------+------------+------------+------------+------------>  | <-+
      +----------------------------------------------------------------------+
         |            |            |            |            |            |
      epoch=3         |         failed       failed       epoch=3      epoch=3
         |            |            |            |            |            |
      CR:SN3          |            |            |            |            |
         |            |            |            |            |            |    <-+
      +----------------------------------------------------------------------+   |
      | WARN: no redundancy!       |            |            |            |  |  (c)
      |  <--write:ok--+------------+------------+------------>            |  |   |
      +----------------------------------------------------------------------+   |
         |            |            |            |            |            |    <-+
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+

위 그림은 SN1에서 SN2를 거쳐 SN3로 이어지는 Chain Replication을 표현한다.  
(a)는 Chain 여기서 Chain의 Head, 즉 SN1이 Fail한 모습니다. CL은 append를 위해
SN1에 write를 하지만, 이 RPC는 실패한다. CL은 reconfiguration을 시작하고, 로컬에
저장된 Projection을 갱신한다. 여기서 두가지 이슈가 있다.

- SN1에 장애가 있음을 확신하기 위한 조건 필요
- Reconfiguration이 짧아야 한다.

CL이 reconfiguration을 완료하여 특정 GLSN을 담당하는 Log Stream의 Chain
Replication이 SN2와 SN3로 이루어지게 된다 (b). SN2가 해당 Chain 의 새로운 head
가 된다. 해당 Log Stream은 replica가 2개인 상태로 정상 동작할 수 있다.  
이때 SN2에 장애가 발생하고 CL이 append를 실패할 수 있다. CL은 다시
reconfiguration을 시도하고, 해당 Log Stream에 대한 Storage Node가 SN3만
남게된다\(c\). SN3는 아래와 같은 동작이 가능하다: 

- 데이터 중복을 제공할 수 없다. (no replica) 이는 availability에 문제가 생길 수
있다.
- 읽기 요청은 안정적으로 받을 수 있다.

### Chain Tail이 Fail한 경우
Chain의 tail은 append에서 가장 마지막에 쓰여지는 노드이다. 즉, tail에 쓰여진
로그 엔트리는 commit된 것이며, replication이 완료된 데이터이다. 그러므로 CL이
read할때 tail 노드만 읽기를 한다. append 과정에서 tail에 해당하는 Storage Node가
fail된 경우, reconfiguration을 하고 실패한 write를 이어서 진행한다.

    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
         |            |            |            |            |            |
      epoch=1         |         epoch=1      epoch=1      epoch=1      epoch=1
         |            |            |            |            |            |
      CR:SN1->SN2->SN3|            |            |            |            |
         |            |            |            |            |            |
         |            |            |            |            |            |
     +-  <--next:ok--->            |            |            |            |
     |   <--write:ok--+------------>            |            |            |
    ++   <--write:ok--+------------+------------>            |            |
    |+-  +--write:error------------+------------+-------->   |            |
    |    |            |            |            |            |            |
    | +----------------------------------------------------------------------+
    | |reconfiguration|            |            |            |            |  |
    | |  +------------+------------>            |            |            |  |
    | |  <------------+------------+------------>            |            |  |
    | |  <------------+------------+------------+------------>            |  |
    | |  <------------+------------+------------+------------+------------>  |
    | +----------------------------------------------------------------------+
    |    |            |            |            |            |            |
    | epoch=2         |        epoch=2       epoch=2      failed       epoch=2
    |    |            |            |            |            |            |
    | CR:SN1->SN2     |            |            |            |            |
    |    |            |            |            |            |            |
    +-->resume append & ok         |            |            |            |
         |            |            |            |            |            |
         |            |            |            |            |            |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+
    |   CL   |   |   SQ   |   |  SN1   |   |  SN2   |   |  SN3   |   |   MR   |
    +--------+   +--------+   +--------+   +--------+   +--------+   +--------+


