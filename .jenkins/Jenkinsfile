pipeline {

  agent any

  stages {

    stage("build") {
      steps {
        sh "make build"
      }
    }

    stage("test") {
      steps {
        sh "make test_ci TEST_FLAGS='-v -race -failfast -count=2 -timeout=30m'"
      }

      post {
        always {
          sh "make test_report"
          junit "reports/*.xml"

          sh "make coverage_report"
          cobertura coberturaReportFile: "reports/coverage.xml"
        }
      }
    }

    /*
    stage("benchmark") {
      steps {
        sh "make bench"

        lock("varlog-sandbox-01") {
          sh "./scripts/benchmark.sh > reports/load.xml"
        }
      }

      post {
        always {
          sh "make bench_report"
          perfReport "reports/bench.xml"
          perfReport "reports/load.xml"
        }
      }
    }
    */

  }

}
